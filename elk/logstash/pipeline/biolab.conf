# ════════════════════════════════════════════════════════════════════════
# BioLabs — Logstash Pipeline
# Ingests structured JSON logs from all microservices via TCP
# ════════════════════════════════════════════════════════════════════════

input {
  # TCP input from logstash-logback-encoder (LogstashTcpSocketAppender)
  tcp {
    port => 5000
    codec => json_lines
    tags => ["biolab", "microservice"]
  }
}

filter {
  # ── Parse timestamp ──────────────────────────────────────────────
  date {
    match => ["@timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # ── Enrich with service metadata ────────────────────────────────
  if [service] {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "biolab-%{service}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "biolab-unknown" }
    }
  }

  # ── Parse log level for severity ────────────────────────────────
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # ── Extract HTTP fields from structured logs ────────────────────
  if [method] and [uri] {
    mutate {
      add_field => { "http.method" => "%{method}" }
      add_field => { "http.url" => "%{uri}" }
    }
  }

  # ── Parse stack trace from exception ────────────────────────────
  if [stack_trace] {
    mutate {
      add_tag => ["has_exception"]
    }
  }

  # ── GeoIP from client IP (optional) ────────────────────────────
  if [clientIp] and [clientIp] !~ /^(127\.|10\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|192\.168\.)/ {
    geoip {
      source => "clientIp"
      target => "geo"
    }
  }

  # ── Clean up internal fields ────────────────────────────────────
  mutate {
    remove_field => ["host", "port", "@version"]
  }
}

output {
  # ── Elasticsearch — daily index per service ─────────────────────
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    manage_template => true
    template_name => "biolab-logs"
    template_overwrite => true
    template => "/usr/share/logstash/templates/biolab-template.json"
  }

  # ── Stdout for debugging (disable in production) ────────────────
  # stdout { codec => rubydebug }
}
